ZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZShzdGF0ZSwgYWN0aW9uKSB7CiAgY29uc3QgY29tcGFueSA9IHN0YXRlLmNvbXBhbnk7IC8vIHN0YXRlIHZhcmlhYmxlCiAgY29uc3QgcGVvcGxlID0gc3RhdGUucGVvcGxlOyAvLyBzdGF0ZSB2YXJpYWJsZQogIGNvbnN0IG1hcDEgPSBzdGF0ZS5tYXAxOyAvLyBzdGF0ZSB2YXJpYWJsZQogIGNvbnN0IG1hcDIgPSBzdGF0ZS5tYXAyOyAvLyBzdGF0ZSB2YXJpYWJsZQogIGNvbnN0IG51bTEgPSBzdGF0ZS5udW0xOyAvLyBzdGF0ZSB2YXJpYWJsZQoKICBjb25zdCBpbnB1dCA9IGFjdGlvbi5pbnB1dDsKICBjb25zdCBjYWxsZXIgPSBhY3Rpb24uY2FsbGVyOwoKICBpZiAoYWN0aW9uLmlucHV0LmZ1bmN0aW9uID09PSAidXBsb2FkX2t5YyIpIHsKICAgIGNvbnN0IGNvbXAgPSBhY3Rpb24uaW5wdXQuY29tcDsgLy8gaW5wdXQgLSB2YXJpYWJsZQogICAgY29uc3Qga3ljID0gYWN0aW9uLmlucHV0Lmt5YzsgLy8gaW5wdXQgLSBvYmplY3QKCiAgICBpZiAoa3ljLm5hbWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKCJQbGVhc2UgZW50ZXIgdGhlIG5hbWUiKTsKICAgIH0KICAgIGlmIChreWMuYWdlID09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiUGxlYXNlIGVudGVyIHRoZSBhZ2UiKTsKICAgIH0KICAgIGlmIChreWMubmF0aW9uID09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiUGxlYXNlIGVudGVyIHRoZSBuYXRpb25hbGl0eSIpOwogICAgfQogICAgaWYgKGt5Yy5waF9ubyA9PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgbmV3IENvbnRyYWN0RXJyb3IoIlBsZWFzZSBlbnRlciB0aGUgcGhvbmUgbnVtYmVyIik7CiAgICB9CiAgICBpZiAoa3ljLmRsID09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiUGxlYXNlIGVudGVyIHRoZSBkcml2aW5nIGxpY2Vuc2UgbnVtYmVyIik7CiAgICB9CgogICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKGt5Yy5waF9ubyAmJiBreWMuYWdlKSkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigKICAgICAgICAnSW52YWxpZCB2YWx1ZSBmb3IgImFnZSBhbmQgcGhvbmUgbnVtYmVyIi4gTXVzdCBiZSBhbiBpbnRlZ2VyLicKICAgICAgKTsKICAgIH0KCiAgICBreWMuYWNjZXNzID0gdHJ1ZTsKICAgIGt5Yy5hZGRyZXNzID0gY2FsbGVyOwoKICAgIGlmIChzdGF0ZS5wZW9wbGVbY29tcF0gPT0gdW5kZWZpbmVkKSB7CiAgICAgIHN0YXRlLnBlb3BsZVtjb21wXSA9IDA7CiAgICB9CgogICAgY29uc3Qga2V5ID0gYCR7Y29tcH0gJHtjYWxsZXJ9YDsKCiAgICB2YXIgY29tcF9pZCA9IHN0YXRlLnBlb3BsZVtjb21wXTsKICAgIHN0YXRlLnBlb3BsZVtjb21wXVtjb21wX2lkXSA9IGt5YzsKICAgIHN0YXRlLm1hcDFba2V5XSA9IHN0YXRlLnBlb3BsZVtjb21wXVtjb21wX2lkXTsKICAgIHN0YXRlLnBlb3BsZVtjb21wXSsrOwogICAgcmV0dXJuIHsgc3RhdGUgfTsKICB9CgogIGlmIChhY3Rpb24uaW5wdXQuZnVuY3Rpb24gPT09ICJjb21wYW55X3JlZyIpIHsKICAgIGNvbnN0IGNvbXAgPSBhY3Rpb24uaW5wdXQuY29tcDsgLy8gaW5wdXQgLSBvYmplY3QKCiAgICBpZiAoY29tcC5uYW1lID09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiUGxlYXNlIGVudGVyIHRoZSBjb21wYW55IG5hbWUiKTsKICAgIH0KICAgIGlmIChjb21wLmNhdGVnb3J5ID09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiUGxlYXNlIGVudGVyIHRoZSB0eXBlIG9mIGNvbXBhbnkiKTsKICAgIH0KICAgIGNvbXAuYWRkcmVzcyA9IGNhbGxlcjsKCiAgICBzdGF0ZS5tYXAyW2NhbGxlcl0gPSBjb21wLm5hbWU7CgogICAgc3RhdGUuY29tcGFueS5wdXNoKGNvbXApOwoKICAgIHJldHVybiB7IHN0YXRlIH07CiAgfQoKICBpZiAoYWN0aW9uLmlucHV0LmZ1bmN0aW9uID09PSAiZ2V0RGV0YWlscyIpIHsKICAgIGNvbnN0IGNvbXAgPSBhY3Rpb24uaW5wdXQuY29tcDsgLy8gaW5wdXQgLSB2YXJpYWJsZQogICAgY29uc3QgYWRkcmVzcyA9IGFjdGlvbi5pbnB1dC5hZGRyZXNzOyAvLyBpbnB1dCAtIHZhcmlhYmxlCgogICAgY29uc3Qga2V5ID0gYCR7Y29tcH0gJHthZGRyZXNzfWA7CgogICAgaWYgKCEoa2V5IGluIHN0YXRlLm1hcDEpKSB7CiAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKAogICAgICAgICJUaGlzIGFkZHJlc3MgZG9lc24ndCBnaXZlIHlvdSB0aGVpciBLWUMgZGV0YWlscyIKICAgICAgKTsKICAgIH0KCiAgICBjb25zdCB4ID0gc3RhdGUubWFwMVtrZXldOwogICAgaWYgKHguYWNjZXNzID09IGZhbHNlKSB7CiAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKAogICAgICAgICJUaGlzIGFkZHJlc3MgZG9lc24ndCBnaXZlIHlvdXIgY29tcGFueSB0byBhY2Nlc3MgdGhlaXIgS1lDIGRldGFpbHMiCiAgICAgICk7CiAgICB9CgogICAgcmV0dXJuIHsgcmVzdWx0OiBzdGF0ZS5tYXAxW2tleV0gfTsKICB9CgogIGlmIChhY3Rpb24uaW5wdXQuZnVuY3Rpb24gPT09ICJybUFjY2Vzc1UiKSB7CiAgICBjb25zdCBjb21wID0gYWN0aW9uLmlucHV0LmNvbXA7IC8vIGlucHV0IC0gdmFyaWFibGUKCiAgICBjb25zdCBrZXkgPSBgJHtjb21wfSAke2NhbGxlcn1gOwoKICAgIGlmICghKGtleSBpbiBzdGF0ZS5tYXAxKSkgewogICAgICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiV3JvbmcgZGV0YWlscyIpOwogICAgfQoKICAgIHN0YXRlLm1hcDFba2V5XS5hY2Nlc3MgPSBmYWxzZTsKCiAgICByZXR1cm4geyBzdGF0ZSB9OwogIH0KCiAgaWYgKGFjdGlvbi5pbnB1dC5mdW5jdGlvbiA9PT0gImdldENvbXBEZXRhaWxzIikgewogICAgcmV0dXJuIHsgcmVzdWx0OiBzdGF0ZS5jb21wIH07CiAgfQogIGlmIChhY3Rpb24uaW5wdXQuZnVuY3Rpb24gPT09ICJnZXRVc2VyIikgewogICAgY29uc3QgY29tcF9uYW1lID0gc3RhdGUubWFwW2NhbGxlcl07CiAgICByZXR1cm4geyByZXN1bHQ6IHN0YXRlLnBlb3BsZVtjb21wX25hbWVdIH07CiAgfQoKICB0aHJvdyBuZXcgQ29udHJhY3RFcnJvcigiVW5zdXBwb3J0ZWQgY29udHJhY3QgZnVuY3Rpb24iKTsKfQo